{% extends 'base.html' %}

{% block title %}Stock Sage - {{ ticker }} 정보{% endblock %}

{% block content %}
    <h1>{{ company_name }} ({{ ticker }}) 주가 정보</h1>

    {% if error %}
        <p>{{ error }}</p>
    {% elif graphic %}
        <p>현재 가격: {{ current_price }}</p>
        <p>전일 종가: {{ previous_close }}</p>
        <img src="data:image/png;base64,{{ graphic }}" alt="{{ ticker }} Graph">
    {% else %}
        <p>주식 코드를 입력해주세요.</p>
    {% endif %}

    <form method="get" action="/stock/info/">
        <input type="text" id="stock-search" name="ticker" placeholder="주식 코드 입력 (예: 068270)" autocomplete="off">
        <button type="submit">검색</button>
        <div id="search-results" style="position: absolute; background: white; border: 1px solid #ccc; z-index: 1000; width: 200px;"></div>
    </form>

    <!-- 관심 종목 토글 버튼 -->
    <button id="toggle-favorite" data-ticker="{{ ticker }}" data-is-favorite="{{ is_favorite|yesno:"true,false" }}">
        {% if is_favorite %}
            관심 종목에서 삭제
        {% else %}
            관심 종목에 추가
        {% endif %}
    </button>

    <h2>댓글</h2>
    <form method="post" action="">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">댓글 남기기</button>
    </form>

    <h3>댓글 목록</h3>
    <ul>
        {% for comment in comments %}
            <li>
                <strong>{{ comment.author }}:</strong>
                <p>{{ comment.comment }}</p>
                <small>{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                <form method="post" action="{% url 'delete_comment' comment.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('이 댓글을 삭제하시겠습니까?');">삭제</button>
                </form>
            </li>
        {% empty %}
            <li>댓글이 없습니다.</li>
        {% endfor %}
    </ul>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#toggle-favorite').click(function() {
                var button = $(this);
                var stockCode = button.data('ticker');
                var isFavorite = button.data('is-favorite');

                $.ajax({
                    url: '{% url "toggle_interest_stock" %}',
                    method: 'POST',
                    data: {
                        'stock_code': stockCode,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            if (response.action === 'added') {
                                button.data('is-favorite', 'true');
                                button.text('관심 종목에서 삭제');
                            } else if (response.action === 'removed') {
                                button.data('is-favorite', 'false');
                                button.text('관심 종목에 추가');
                            }
                        } else {
                            alert('작업에 실패했습니다. 다시 시도해 주세요.');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX 요청 실패:', status, error);
                    }
                });
            });
        });
    </script>
{% endblock %}
